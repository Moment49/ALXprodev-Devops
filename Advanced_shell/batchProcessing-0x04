#!/bin/bash

pokemon_list='["bulbasaur", "ivysaur", "venusaur", "charmander", "charmeleon"]'
timeout_sec=10
max_attempts=3

fetch_pokemon() {
  local pokemon=$1
  echo "Starting fetch for $pokemon..."

  local attempt=0
  local success=0

  while (( attempt < max_attempts )); do
    ((attempt++))
    
    curl -s -o "$pokemon.json" "https://pokeapi.co/api/v2/pokemon/$pokemon" &
    pid=$!
    
    local waited=0
    while kill -0 "$pid" 2>/dev/null; do
      sleep 1
      ((waited++))
      if (( waited >= timeout_sec )); then
        echo "Timeout reached for $pokemon (attempt $attempt), killing process $pid"
        kill "$pid"
        wait "$pid" 2>/dev/null
        break
      fi
    done
    
    wait "$pid"
    http_code=$?
    
    if [[ $http_code -eq 0 && -s "$pokemon.json" ]]; then
      echo "Successfully saved $pokemon.json"
      success=1
      break
    else
      echo "Attempt $attempt failed for $pokemon, retrying..."
      sleep 2
    fi
  done

  if (( success == 0 )); then
    echo "Failed to fetch $pokemon after $max_attempts attempts."
    [[ -f "$pokemon.json" ]] && rm "$pokemon.json"
  fi
}

export -f fetch_pokemon

# Start fetch jobs in background
for pokemon in $(echo "$pokemon_list" | jq -r '.[]'); do
  fetch_pokemon "$pokemon" &
done

# Show running jobs
echo "Current background jobs:"
jobs

# Wait for all jobs to finish
wait

echo "All Pok√©mon data fetched."
